<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Membros - Igreja Adere Vidas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        /* Header e Navegação */
        header {
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }
        
        .header-title {
            font-size: 22px;
            font-weight: 600;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info span {
            margin-right: 15px;
        }
        
    .logout-btn, .back-btn {
    background-color: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
    margin-left: 10px;
}

.logout-btn:hover, .back-btn:hover {
    background-color: rgba(255, 255, 255, 0.3);
}
        
        /* Menu de Navegação */
        nav {
            background-color: #2c3e50;
            padding: 0 20px;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .menu {
            list-style-type: none;
            display: flex;
        }
        
        .menu-item {
            position: relative;
        }
        
        .menu-item > a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            transition: background-color 0.3s;
        }
        
        .menu-item > a:hover {
            background-color: #34495e;
        }
        
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-radius: 0 0 5px 5px;
            display: none;
            z-index: 10;
        }
        
        .dropdown-item {
            display: block;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .dropdown-item:hover {
            background-color: #f0f0f0;
        }
        
        .menu-item:hover .dropdown {
            display: block;
        }
        
        /* Conteúdo Principal */
        .main-content {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .page-title {
            color: #1a2a6c;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #1a2a6c, #b21f1f);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #24378a, #c52d2d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* Abas */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #1a2a6c;
            border-bottom: 3px solid #1a2a6c;
        }
        
        .tab:hover {
            color: #1a2a6c;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards de membros */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .member-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s;
            position: relative;
        }
        
        .member-card.pendente {
            border-left: 5px solid #ffc107;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .member-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .member-info {
            padding: 15px;
        }
        
        .member-id {
            background-color: #1a2a6c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .member-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pendente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .member-name {
            font-size: 18px;
            font-weight: 600;
            color: #1a2a6c;
            margin-bottom: 5px;
        }
        
        .member-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .member-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .btn-edit:hover {
            background-color: #e0e0e0;
        }
        
        .btn-deactivate {
            background-color: #ffcccc;
            color: #b21f1f;
        }
        
        .btn-deactivate:hover {
            background-color: #ffb3b3;
        }
        
        .btn-activate {
            background-color: #d4edda;
            color: #155724;
        }
        
        .btn-activate:hover {
            background-color: #c3e6cb;
        }
        
        .btn-accept {
            background-color: #d4edda;
            color: #155724;
        }
        
        .btn-accept:hover {
            background-color: #c3e6cb;
        }
        
        .btn-reject {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .btn-reject:hover {
            background-color: #f5c6cb;
        }
        
        /* Modal de cadastro */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            color: #1a2a6c;
            font-size: 20px;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #1a2a6c;
            outline: none;
        }
        
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        
        .photo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            grid-column: 1 / -1;
        }
        
        .photo-preview {
            width: 150px;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .upload-btn {
            background-color: #f0f0f0;
            color: #555;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .upload-btn:hover {
            background-color: #e0e0e0;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-cancel {
            background-color: #f0f0f0;
            color: #333;
            margin-right: 10px;
        }
        
        .btn-cancel:hover {
            background-color: #e0e0e0;
        }
        
        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #1a2a6c;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 50px;
        }
        
        /* Estilos para a aba de carteirinhas */
        .selected-members-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .selected-member {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .selected-member:hover {
            background-color: #e9ecef;
        }
        
        .remove-member {
            background: none;
            border: none;
            color: #b21f1f;
            cursor: pointer;
            font-size: 16px;
        }
        
        .search-results {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .search-result-item:hover {
            background-color: #f0f0f0;
        }
        
        .card-preview {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
        }
        
        .card-front, .card-back {
            width: 350px;
            height: 220px;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            margin: 10px auto;
            position: relative;
            box-sizing: border-box;
        }
        
        .card-front {
            background: linear-gradient(to bottom, #1a2a6c, #2c3e50);
            color: white;
        }
        
        .card-back {
            background: white;
            color: #333;
        }
        
        .card-header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .card-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            display: block;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        .card-details {
            margin-bottom: 10px;
        }
        
        .card-field {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .card-label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 30px;
            padding-top: 5px;
            text-align: center;
            font-size: 12px;
        }
        
        .close-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .pending-badge {
            background: #ffc107;
            color: #856404;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo-container {
                margin-bottom: 15px;
            }
            
            .menu {
                flex-direction: column;
            }
            
            .dropdown {
                position: static;
                width: 100%;
                display: none;
                box-shadow: none;
                border-radius: 0;
            }
            
            .menu-item:hover .dropdown {
                display: none;
            }
            
            .menu-item.active .dropdown {
                display: block;
            }
            
            .members-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                text-align: center;
                padding: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .member-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-btn {
                width: 100%;
            }
            
            .card-front, .card-back {
                width: 300px;
                height: 200px;
            }
        }

  /* CSS da tabela com centralização */
.members-table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-top: 20px;
}

.members-table {
    width: 100%;
    border-collapse: collapse;
}

.members-table th {
    background: linear-gradient(to right, #1a2a6c, #b21f1f);
    color: white;
    padding: 15px;
    text-align: center;
    font-weight: 600;
}

/* Coluna do nome alinhada à esquerda */
.members-table th:nth-child(2) {
    text-align: left;
}

.members-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    text-align: center;
}

/* Coluna do nome alinhada à esquerda */
.members-table td:nth-child(2) {
    text-align: left;
}

.members-table tr:hover {
    background-color: #f8f9fa;
}

.members-table tr:last-child td {
    border-bottom: none;
}

.table-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.btn-action {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
}

.btn-view {
    background-color: #1a2a6c;
    color: white;
}

.btn-view:hover {
    background-color: #24378a;
}

.btn-edit {
    background-color: #ffc107;
    color: #333;
}

.btn-edit:hover {
    background-color: #e0a800;
}

.btn-deactivate {
    background-color: #dc3545;
    color: white;
}

.btn-deactivate:hover {
    background-color: #c82333;
}

.btn-delete {
    background-color: #6c757d;
    color: white;
}

.btn-delete:hover {
    background-color: #5a6268;
}

.no-members {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* Para garantir que as colunas tenham larguras adequadas */
.members-table th:nth-child(1),
.members-table td:nth-child(1) {
    width: 80px; /* ID */
}

.members-table th:nth-child(2),
.members-table td:nth-child(2) {
    width: auto; /* Nome - ocupa o espaço restante */
}

.members-table th:nth-child(3),
.members-table td:nth-child(3) {
    width: 120px; /* Função */
}

.members-table th:nth-child(4),
.members-table td:nth-child(4) {
    width: 150px; /* Congregação */
}

.members-table th:nth-child(5),
.members-table td:nth-child(5) {
    width: 300px; /* Ações */
}

/* Estilos para o campo de busca */
.search-container {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.search-box i.fa-search {
    position: absolute;
    left: 15px;
    color: #666;
    z-index: 2;
}

.search-input {
    width: 100%;
    padding: 12px 45px 12px 45px;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 14px;
    transition: all 0.3s;
}

.search-input:focus {
    outline: none;
    border-color: #1a2a6c;
    box-shadow: 0 0 0 2px rgba(26, 42, 108, 0.1);
}

.clear-search-btn {
    position: absolute;
    right: 15px;
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.3s;
}

.clear-search-btn:hover {
    background: #f0f0f0;
    color: #333;
}

.search-results-info {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
    text-align: center;
}
/* Adicione este CSS para melhorar a exibição de nenhum resultado */
.no-members i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
    color: #999;
}

.no-members strong {
    color: #1a2a6c;
}
    </style>
</head>
<body>
  <header>
        <div class="header-content">
            <div class="logo-container">
                <img src="https://i.ibb.co/Ng3DKmJK/logo-igreja.png" alt="Logo Igreja" class="logo">
                <div class="header-title">Gerenciamento de Membros - Igreja Adere Vidas</div>
            </div>
            <div class="user-info">
                <span id="current-filial-info">Filial: Carregando...</span>
                <button class="back-btn" onclick="window.location.href='main.html'"><i class="fas fa-arrow-left"></i> Voltar</button>
                <button class="logout-btn">Sair <i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>
    
    <div class="main-content">
        <div class="page-title">
            <h1>Gerenciamento de Membros</h1>
            <button class="btn btn-primary" id="add-member-btn">
                <i class="fas fa-plus"></i> Cadastrar Membro
            </button>
        </div>
        
        <div class="alert alert-success" id="success-alert">
            <i class="fas fa-check-circle"></i> <span id="success-message"></span>
        </div>
        
        <div class="alert alert-error" id="error-alert">
            <i class="fas fa-exclamation-circle"></i> <span id="error-message"></span>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="ativos">Ativos</div>
            <div class="tab" data-tab="desligados">Desligados</div>
            <div class="tab" data-tab="online">Solicitações <span id="pending-count" class="pending-badge">0</span></div>
            <div class="tab" data-tab="carteirinhas">Carteirinhas</div>
        </div>

        <!-- Adicione este código após as abas e antes do loading -->
<div class="search-container" style="margin-bottom: 20px; display: none;" id="search-container">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="member-search-input" placeholder="Buscar por ID, Nome, Função ou Congregação..." class="search-input">
        <button id="clear-search" class="clear-search-btn" style="display: none;">
            <i class="fas fa-times"></i>
        </button>
    </div>
     </div>
     

        
        <div class="loading" id="loading-members">
            <div class="loading-spinner"></div>
            <p>Carregando membros...</p>
        </div>
        
        <div class="tab-content active" id="ativos-content">
            <div class="members-grid" id="ativos-list">
                <!-- Membros ativos serão carregados aqui -->
            </div>
        </div>
        
        <div class="tab-content" id="desligados-content">
            <div class="members-grid" id="desligados-list">
                <!-- Membros desligados serão carregados aqui -->
            </div>
        </div>
        
        <div class="tab-content" id="online-content">
            <div class="members-grid" id="online-list">
                <!-- Solicitações de membros serão carregadas aqui -->
            </div>
        </div>
        
        <div class="tab-content" id="carteirinhas-content">
            <div class="form-card">
                <h2 class="form-title">Gerar Carteirinhas</h2>
                
                <div class="form-group">
                    <label for="member-search">Buscar Membro</label>
                    <input type="text" id="member-search" class="form-control" placeholder="Digite o nome do membro">
                </div>
                
                <div class="form-group">
                    <label>Membros Selecionados</label>
                    <div id="selected-members" class="selected-members-container">
                        <p>Nenhum membro selecionado</p>
                    </div>
                </div>
                
                <div class="btn-container">
                    <button class="btn btn-primary" id="generate-cards-btn">
                        <i class="fas fa-id-card"></i> Gerar Carteirinhas
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Cadastro de Membro -->
    <div class="modal" id="member-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Cadastrar Novo Membro</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="member-form">
                    <div class="photo-upload">
                        <div class="photo-preview" id="photo-preview">
                            <i class="fas fa-user fa-3x" style="color: #ddd;"></i>
                        </div>
                        <label for="photo-input" class="upload-btn">
                            <i class="fas fa-upload"></i> Selecionar Foto 3x4
                        </label>
                        <input type="file" id="photo-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nome">Nome Completo *</label>
                            <input type="text" id="nome" class="form-control" placeholder="Digite o nome completo" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="cpf">CPF</label>
                            <input type="text" id="cpf" class="form-control" placeholder="000.000.000-00">
                        </div>
                        
                        <div class="form-group">
                            <label for="data-nascimento">Data de Nascimento</label>
                            <input type="date" id="data-nascimento" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="data-entrada">Data de Entrada *</label>
                            <input type="date" id="data-entrada" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="data-batismo">Data de Batismo</label>
                            <input type="date" id="data-batismo" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="conjuge">Nome do Cônjuge</label>
                            <input type="text" id="conjuge" class="form-control" placeholder="Nome do cônjuge">
                        </div>
                        
                        <div class="form-group">
                            <label for="mae">Nome da Mãe</label>
                            <input type="text" id="mae" class="form-control" placeholder="Nome completo da mãe">
                        </div>
                        
                        <div class="form-group">
                            <label for="pai">Nome do Pai</label>
                            <input type="text" id="pai" class="form-control" placeholder="Nome completo do pai">
                        </div>
                        
                        <div class="form-group">
                            <label for="email">E-mail</label>
                            <input type="email" id="email" class="form-control" placeholder="Digite o e-mail">
                        </div>
                        
                        <div class="form-group">
                            <label for="telefone">Telefone</label>
                            <input type="tel" id="telefone" class="form-control" placeholder="(00) 00000-0000">
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="endereco">Endereço</label>
                            <input type="text" id="endereco" class="form-control" placeholder="Digite o endereço completo">
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="observacao">Observações</label>
                            <textarea id="observacao" class="form-control" placeholder="Informações adicionais sobre o membro"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" id="cancel-btn">Cancelar</button>
                <button class="btn btn-primary" id="save-member-btn">Salvar</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Sistema de Gestão - Igreja Adere Vidas &copy; 2023</p>
    </footer>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBNmIm9kem9yKp9skGS2HKHwqaauK36aps",
            authDomain: "dbaderevidas-9cbd0.firebaseapp.com",
            projectId: "dbaderevidas-9cbd0",
            storageBucket: "dbaderevidas-9cbd0.firebasestorage.app",
            messagingSenderId: "762500930740",
            appId: "1:762500930740:web:ff13ea2685e2db28ec0be1"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Elementos da interface
        const headerUsername = document.getElementById('header-username');
        const successAlert = document.getElementById('success-alert');
        const successMessage = document.getElementById('success-message');
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');
        const loadingMembers = document.getElementById('loading-members');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const addMemberBtn = document.getElementById('add-member-btn');
        const memberModal = document.getElementById('member-modal');
        const closeModalBtn = document.querySelector('.close-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const saveMemberBtn = document.getElementById('save-member-btn');
        const memberForm = document.getElementById('member-form');
        const photoInput = document.getElementById('photo-input');
        const photoPreview = document.getElementById('photo-preview');
        const pendingCount = document.getElementById('pending-count');
        
        // Variáveis globais
        let currentUser = null;
        let selectedTab = 'ativos';
        let photoBase64 = null;
        let allMembers = [];
        let selectedMembers = [];

         // Estado da aplicação
        let currentFilial = null;

        // Elementos da interface
        const currentFilialInfo = document.getElementById('current-filial-info');

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se o usuário está logado
            const userData = sessionStorage.getItem('user');
            
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            
            // Obter a filial atual da URL ou localStorage
            const urlParams = new URLSearchParams(window.location.search);
            const filialId = urlParams.get('filial') || localStorage.getItem('currentFilialId');
            
            if (filialId) {
                loadFilialInfo(filialId);
            } else {
                currentFilialInfo.textContent = 'Filial: Não selecionada';
                loadMembers(); // Carregar membros mesmo sem filial selecionada
            }
            
            // Configurar eventos
            setupEventListeners();

            initSearch();
        });

        // Carregar informações da filial
        async function loadFilialInfo(filialId) {
            try {
                const filialDoc = await db.collection('filiais').doc(filialId).get();
                if (filialDoc.exists) {
                    currentFilial = filialDoc.data();
                    currentFilial.id = filialId;
                    currentFilialInfo.textContent = `Filial: ${currentFilial.congregacao}`;
                } else {
                    currentFilialInfo.textContent = 'Filial: Não encontrada';
                }
                
                // Carregar membros após carregar a filial atual
                loadMembers();
            } catch (error) {
                console.error('Erro ao carregar informações da filial:', error);
                currentFilialInfo.textContent = 'Filial: Erro ao carregar';
                loadMembers(); // Carregar membros mesmo com erro
            }
        }

        // Configurar eventos
        function setupEventListeners() {
            // Logout
            document.querySelector('.logout-btn').addEventListener('click', function() {
                if(confirm('Deseja realmente sair do sistema?')) {
                    sessionStorage.removeItem('user');
                    localStorage.removeItem('currentFilialId');
                    window.location.href = 'index.html';
                }
            });
        }

        
        
        // Máscara para CPF
        function aplicarMascaraCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
            cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            return cpf;
        }
        
        // Máscara para telefone
        function aplicarMascaraTelefone(telefone) {
            telefone = telefone.replace(/\D/g, '');
            if (telefone.length <= 10) {
                telefone = telefone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else {
                telefone = telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            return telefone;
        }
        
        // Aplicar máscaras aos campos
        document.getElementById('cpf').addEventListener('input', function(e) {
            e.target.value = aplicarMascaraCPF(e.target.value);
        });
        
        document.getElementById('telefone').addEventListener('input', function(e) {
            e.target.value = aplicarMascaraTelefone(e.target.value);
        });
        
        // Verificar se o usuário está logado
        document.addEventListener('DOMContentLoaded', function() {
            const userData = sessionStorage.getItem('user');
            
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            loadMembers();
            initCardGeneration();
        });
        
        // Funcionalidade das abas
       tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        
        // Ativar aba clicada
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Mostrar conteúdo correspondente
        tabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === `${tabId}-content`) {
                content.classList.add('active');
            }
        });
        
        selectedTab = tabId;
        
        // Atualizar visibilidade do campo de busca
        updateSearchVisibility();
        
        // Limpar busca ao trocar de aba
        const searchInput = document.getElementById('member-search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        clearSearch();
    });
});
        
        // Abrir modal de cadastro
        addMemberBtn.addEventListener('click', () => {
            memberModal.classList.add('active');
        });
        
        // Fechar modal
        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);
        
       function closeModal() {
    memberModal.classList.remove('active');
    memberForm.reset();
    photoPreview.innerHTML = '<i class="fas fa-user fa-3x" style="color: #ddd;"></i>';
    photoBase64 = null;
    
    // Resetar o botão salvar para o comportamento padrão (cadastrar)
    const saveBtn = document.getElementById('save-member-btn');
    saveBtn.textContent = 'Salvar';
    saveBtn.onclick = function() {
        saveNewMember();
    };
    
    // Resetar o título do modal
    document.querySelector('.modal-title').textContent = 'Cadastrar Novo Membro';
}
        
        
        // Upload de foto
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    // Comprimir a imagem
                    compressImage(event.target.result, 150, 150, 0.7, function(compressedImage) {
                        photoBase64 = compressedImage;
                        photoPreview.innerHTML = `<img src="${compressedImage}" alt="Preview">`;
                    });
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        // Função para comprimir imagem
        function compressImage(src, maxWidth, maxHeight, quality, callback) {
            const img = new Image();
            img.src = src;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // Calcular novas dimensões mantendo a proporção
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // Converter para base64 com qualidade reduzida
                callback(canvas.toDataURL('image/jpeg', quality));
            };
        }
        
        // Gerar ID aleatório de 4 dígitos
        function generateMemberId() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }
        
        // Salvar membro
        async function saveNewMember() {
    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const cpf = document.getElementById('cpf').value.trim();
    const dataNascimento = document.getElementById('data-nascimento').value;
    const dataBatismo = document.getElementById('data-batismo').value;
    const conjuge = document.getElementById('conjuge').value.trim();
    const mae = document.getElementById('mae').value.trim();
    const pai = document.getElementById('pai').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const dataEntrada = document.getElementById('data-entrada').value;
    const observacao = document.getElementById('observacao').value.trim();
    
    // Validar campos obrigatórios
    if (!nome || !dataEntrada) {
        showError('Por favor, preencha os campos obrigatórios.');
        return;
    }
    
    try {
        // Gerar ID único para o membro
        const memberId = generateMemberId();
        
        // Salvar membro no Firestore
        await db.collection('membros').add({
            id: memberId,
            nome: nome,
            email: email,
            telefone: telefone,
            cpf: cpf,
            dataNascimento: dataNascimento,
            dataBatismo: dataBatismo,
            conjuge: conjuge,
            mae: mae,
            pai: pai,
            endereco: endereco,
            dataEntrada: dataEntrada,
            observacao: observacao,
            foto: photoBase64,
            status: 'ativo',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser.id
        });
        
        // Mostrar mensagem de sucesso
        successMessage.textContent = 'Membro cadastrado com sucesso!';
        successAlert.style.display = 'block';
        
        // Fechar modal e atualizar lista
        closeModal();
        loadMembers();
        
    } catch (error) {
        showError('Erro ao cadastrar membro: ' + error.message);
    }
}
        
       // Adicione esta variável global no início com as outras
let isLoadingMembers = false;

// Carregar membros do Firestore - VERSÃO CORRIGIDA
async function loadMembers() {
    if (isLoadingMembers) return;
    
    isLoadingMembers = true;
    
    try {
        loadingMembers.style.display = 'block';
        
        // Limpar e criar estrutura de tabela
        const ativosContent = document.getElementById('ativos-content');
        const desligadosContent = document.getElementById('desligados-content');
        const onlineContent = document.getElementById('online-content');
        
        // Estrutura para membros ativos
        ativosContent.innerHTML = `
            <div class="members-table-container">
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Função</th>
                            <th>Congregação</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="ativos-list"></tbody>
                </table>
            </div>
        `;
        
        // Estrutura para membros desligados
        desligadosContent.innerHTML = `
            <div class="members-table-container">
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Função</th>
                            <th>Congregação</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="desligados-list"></tbody>
                </table>
            </div>
        `;
        
        // Estrutura para solicitações (mantém cards por enquanto)
        onlineContent.innerHTML = '<div class="members-grid" id="online-list"></div>';
        
        const ativosList = document.getElementById('ativos-list');
        const desligadosList = document.getElementById('desligados-list');
        const onlineList = document.getElementById('online-list');
        
        const membrosSnapshot = await db.collection('membros')
            .orderBy('createdAt', 'desc')
            .get();
        
        // Limpar array global
        currentFilteredMembers = [];
        
        if (membrosSnapshot.empty) {
            ativosList.innerHTML = '<tr><td colspan="5" class="no-members">Nenhum membro cadastrado</td></tr>';
            desligadosList.innerHTML = '<tr><td colspan="5" class="no-members">Nenhum membro desligado</td></tr>';
            onlineList.innerHTML = '<p>Nenhuma solicitação pendente</p>';
            pendingCount.textContent = '0';
            return;
        }
        
        let pendentesCount = 0;
        
        membrosSnapshot.forEach(doc => {
            const membro = doc.data();
            const memberWithId = {
                id: doc.id,
                ...membro
            };
            
            // Adicionar ao array global para filtragem
            currentFilteredMembers.push(memberWithId);
            
            if (membro.status === 'pendente') {
                const card = createPendingMemberCard(doc.id, membro);
                onlineList.appendChild(card);
                pendentesCount++;
            } else if (membro.status === 'ativo') {
                const row = createMemberTableRow(doc.id, membro);
                ativosList.appendChild(row);
            } else if (membro.status === 'desligado') {
                const row = createMemberTableRow(doc.id, membro);
                desligadosList.appendChild(row);
            }
        });
        
        // Atualizar contador e verificar listas vazias
        pendingCount.textContent = pendentesCount;
        
        if (ativosList.children.length === 0) {
            ativosList.innerHTML = '<tr><td colspan="5" class="no-members">Nenhum membro ativo</td></tr>';
        }
        
        if (desligadosList.children.length === 0) {
            desligadosList.innerHTML = '<tr><td colspan="5" class="no-members">Nenhum membro desligado</td></tr>';
        }
        
        if (pendentesCount === 0 && onlineList.children.length === 0) {
            onlineList.innerHTML = '<p>Nenhuma solicitação pendente</p>';
        }
        
    } catch (error) {
        console.error('Erro ao carregar membros:', error);
        showError('Erro ao carregar membros.');
    } finally {
        loadingMembers.style.display = 'none';
        isLoadingMembers = false;
    }
}
        // Criar card de membro pendente
        function createPendingMemberCard(id, membro) {
            const card = document.createElement('div');
            card.className = 'member-card pendente';
            
            // Formatar data de entrada
            const dataEntrada = membro.dataEntrada ? 
                new Date(membro.dataEntrada).toLocaleDateString('pt-BR') : 
                'Data não informada';
            
            // Formatar data de nascimento
            const dataNascimento = membro.dataNascimento ? 
                new Date(membro.dataNascimento).toLocaleDateString('pt-BR') : 
                'Data não informada';
            
            card.innerHTML = `
                <img src="${membro.foto || 'https://via.placeholder.com/280x200?text=Sem+Foto'}" alt="${membro.nome}" class="member-photo">
                <div class="member-info">
                    <div class="member-status status-pendente">Pendente</div>
                    <div class="member-id">ID: ${membro.id || 'N/A'}</div>
                    <h3 class="member-name">${membro.nome}</h3>
                    <div class="member-details">
                        <p><i class="fas fa-calendar-alt"></i> Solicitação: ${dataEntrada}</p>
                        ${membro.dataNascimento ? `<p><i class="fas fa-birthday-cake"></i> Nascimento: ${dataNascimento}</p>` : ''}
                        ${membro.telefone ? `<p><i class="fas fa-phone"></i> ${membro.telefone}</p>` : ''}
                        ${membro.email ? `<p><i class="fas fa-envelope"></i> ${membro.email}</p>` : ''}
                    </div>
                    <div class="member-actions">
                        <button class="action-btn btn-accept" data-id="${id}">
                            <i class="fas fa-check"></i> Aceitar
                        </button>
                        <button class="action-btn btn-reject" data-id="${id}">
                            <i class="fas fa-times"></i> Recusar
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar event listeners aos botões
            const acceptBtn = card.querySelector('.btn-accept');
            const rejectBtn = card.querySelector('.btn-reject');
            
            if (acceptBtn) {
                acceptBtn.addEventListener('click', () => {
                    acceptMember(id);
                });
            }
            
            if (rejectBtn) {
                rejectBtn.addEventListener('click', () => {
                    rejectMember(id);
                });
            }
            
            return card;
        }
        
        // Criar card de membro
       function createMemberTableRow(id, membro) {
    const row = document.createElement('tr');
    
    row.innerHTML = `
    <td>${membro.id || 'N/A'}</td>
    <td>${membro.nome || 'N/A'}</td>
    <td>${membro.funcao || 'Membro'}</td>
    <td>${currentFilial ? currentFilial.congregacao : 'Não informada'}</td>
    <td>
        <div class="table-actions">
            <button class="btn-action btn-view" data-id="${id}" title="Ver detalhes">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn-action btn-edit" data-id="${id}" title="Editar">
                <i class="fas fa-edit"></i>
            </button>
            ${membro.status === 'ativo' ? 
                `<button class="btn-action btn-deactivate" data-id="${id}" title="Desligar">
                    <i class="fas fa-user-times"></i>
                </button>` : 
                `<button class="btn-action btn-activate" data-id="${id}" title="Reativar">
                    <i class="fas fa-user-check"></i>
                </button>`
            }
            <button class="btn-action btn-delete" data-id="${id}" title="Excluir">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
`;
    
    // Adicionar event listeners aos botões
    const viewBtn = row.querySelector('.btn-view');
    const editBtn = row.querySelector('.btn-edit');
    const deactivateBtn = row.querySelector('.btn-deactivate');
    const activateBtn = row.querySelector('.btn-activate');
    const deleteBtn = row.querySelector('.btn-delete');
    
    if (viewBtn) {
        viewBtn.addEventListener('click', () => {
            viewMemberDetails(id, membro);
        });
    }
    
    if (editBtn) {
        editBtn.addEventListener('click', () => {
            editMember(id, membro);
        });
    }
    
    if (deactivateBtn) {
        deactivateBtn.addEventListener('click', () => {
            updateMemberStatus(id, 'desligado');
        });
    }
    
    if (activateBtn) {
        activateBtn.addEventListener('click', () => {
            updateMemberStatus(id, 'ativo');
        });
    }
    
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            deleteMember(id);
        });
    }
    
    return row;
}
        
        // Aceitar membro (mover para ativos)
        async function acceptMember(id) {
            if (!confirm('Tem certeza que deseja aceitar este membro?')) {
                return;
            }
            
            try {
                await db.collection('membros').doc(id).update({
                    status: 'ativo',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                successMessage.textContent = 'Membro aceito com sucesso!';
                successAlert.style.display = 'block';
                
                loadMembers();
                
            } catch (error) {
                showError('Erro ao aceitar membro: ' + error.message);
            }
        }
        
        // Recusar membro (excluir)
        async function rejectMember(id) {
            if (!confirm('Tem certeza que deseja recusar este membro? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                await db.collection('membros').doc(id).delete();
                
                successMessage.textContent = 'Membro recusado com sucesso!';
                successAlert.style.display = 'block';
                
                loadMembers();
                
            } catch (error) {
                showError('Erro ao recusar membro: ' + error.message);
            }
        }
        
        // Atualizar status do membro (ativo/desligado)
       async function updateMember(id) {
    const nome = document.getElementById('nome').value.trim();
    const email = document.getElementById('email').value.trim();
    const telefone = document.getElementById('telefone').value.trim();
    const cpf = document.getElementById('cpf').value.trim();
    const dataNascimento = document.getElementById('data-nascimento').value;
    const dataBatismo = document.getElementById('data-batismo').value;
    const conjuge = document.getElementById('conjuge').value.trim();
    const mae = document.getElementById('mae').value.trim();
    const pai = document.getElementById('pai').value.trim();
    const endereco = document.getElementById('endereco').value.trim();
    const dataEntrada = document.getElementById('data-entrada').value;
    const observacao = document.getElementById('observacao').value.trim();
    
    if (!nome || !dataEntrada) {
        showError('Por favor, preencha os campos obrigatórios.');
        return;
    }
    
    try {
        await db.collection('membros').doc(id).update({
            nome: nome,
            email: email,
            telefone: telefone,
            cpf: cpf,
            dataNascimento: dataNascimento,
            dataBatismo: dataBatismo,
            conjuge: conjuge,
            mae: mae,
            pai: pai,
            endereco: endereco,
            dataEntrada: dataEntrada,
            observacao: observacao,
            foto: photoBase64,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        successMessage.textContent = 'Membro atualizado com sucesso!';
        successAlert.style.display = 'block';
        
        closeModal();
        loadMembers();
        
    } catch (error) {
        showError('Erro ao atualizar membro: ' + error.message);
    }
}
        
        // Inicializar funcionalidade de carteirinhas
        function initCardGeneration() {
            loadAllMembers();
            setupMemberSearch();
            
            document.getElementById('generate-cards-btn').addEventListener('click', function() {
                if (selectedMembers.length === 0) {
                    showError('Selecione pelo menos um membro para gerar carteirinhas.');
                    return;
                }
                generateCardsPDF();
            });
        }
        
        // Carregar todos os membros para busca
        async function loadAllMembers() {
            try {
                const membersSnapshot = await db.collection('membros').get();
                allMembers = [];
                
                membersSnapshot.forEach(doc => {
                    const memberData = doc.data();
                    allMembers.push({
                        id: doc.id,
                        ...memberData
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar membros:', error);
            }
        }
        
        // Configurar busca de membros
        function setupMemberSearch() {
            const searchInput = document.getElementById('member-search');
            let searchResults = null;
            
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                // Remover resultados anteriores
                if (searchResults) {
                    searchResults.remove();
                }
                
                if (searchTerm.length < 2) {
                    return;
                }
                
                // Filtrar membros
                const filteredMembers = allMembers.filter(member => 
                    member.nome && member.nome.toLowerCase().includes(searchTerm)
                );
                
                if (filteredMembers.length === 0) {
                    return;
                }
                
                // Criar elemento de resultados
                searchResults = document.createElement('div');
                searchResults.className = 'search-results';
                
                filteredMembers.forEach(member => {
                    // Verificar se o membro já foi selecionado
                    if (selectedMembers.some(m => m.id === member.id)) {
                        return;
                    }
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'search-result-item';
                    resultItem.textContent = member.nome;
                    
                    resultItem.addEventListener('click', function() {
                        addSelectedMember(member);
                        searchInput.value = '';
                        searchResults.remove();
                        searchResults = null;
                    });
                    
                    searchResults.appendChild(resultItem);
                });
                
                // Posicionar e exibir resultados
                searchInput.parentNode.appendChild(searchResults);
            });
            
            // Fechar resultados ao clicar fora
            document.addEventListener('click', function(e) {
                if (searchResults && !searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.remove();
                    searchResults = null;
                }
            });
        }
        
        // Adicionar membro à lista de selecionados
        function addSelectedMember(member) {
            // Verificar se já foi adicionado
            if (selectedMembers.some(m => m.id === member.id)) {
                return;
            }
            
            selectedMembers.push(member);
            renderSelectedMembers();
        }
        
        // Renderizar membros selecionados
        function renderSelectedMembers() {
            const container = document.getElementById('selected-members');
            container.innerHTML = '';
            
            if (selectedMembers.length === 0) {
                container.innerHTML = '<p>Nenhum membro selecionado</p>';
                return;
            }
            
            selectedMembers.forEach(member => {
                const memberEl = document.createElement('div');
                memberEl.className = 'selected-member';
                memberEl.innerHTML = `
                    <span>${member.nome}</span>
                    <button class="remove-member" data-id="${member.id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(memberEl);
            });
            
            // Adicionar event listeners aos botões de remover
            document.querySelectorAll('.remove-member').forEach(btn => {
                btn.addEventListener('click', function() {
                    const memberId = this.getAttribute('data-id');
                    removeSelectedMember(memberId);
                });
            });
        }
        
        // Remover membro da lista de selecionados
        function removeSelectedMember(memberId) {
            selectedMembers = selectedMembers.filter(member => member.id !== memberId);
            renderSelectedMembers();
        }
        
        // Gerar PDF das carteirinhas
          async function generateCardsPDF() {
        try {
            // Usando a biblioteca jsPDF para gerar o PDF
            const { jsPDF } = window.jspdf;
            
            // Configurar PDF no formato A4 (210x297mm) em modo retrato
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Carregar a logo da igreja
            const logoUrl = 'https://i.ibb.co/Ng3DKmJK/logo-igreja.png';
            
            // Tamanho da carteirinha em mm (9,6 cm x 5,5 cm = 96mm x 55mm)
            const cardWidth = 78;
            const cardHeight = 45;
            
            // Margens e espaçamento
            const margin = 15;
            const spacing = 5;
            
            // Calcular quantas carteirinhas cabem por página (2 por coluna)
            const cardsPerCol = 2;
            const cardsPerPage = cardsPerCol * 2; // 2 colunas (frente e verso) x 2 linhas
            
            // Data atual e data de validade (3 meses depois)
            const hoje = new Date();
            const dataValidade = new Date();
            dataValidade.setMonth(hoje.getMonth() + 3);
            
            const dataEmissaoFormatada = hoje.toLocaleDateString('pt-BR');
            const dataValidadeFormatada = dataValidade.toLocaleDateString('pt-BR');
            
            for (let i = 0; i < selectedMembers.length; i++) {
                // Adicionar nova página se necessário
                if (i > 0 && i % cardsPerPage === 0) {
                    doc.addPage();
                }
                
                const member = selectedMembers[i];
                const cardIndex = i % cardsPerPage;
                
                // Calcular posição na página - coluna da esquerda (frente)
                const row = Math.floor(cardIndex / 2); // 0 ou 1
                const col = cardIndex % 2; // 0 (esquerda) ou 1 (direita)
                
                const x = margin + col * (cardWidth + spacing);
                const y = margin + row * (cardHeight + spacing);
                
                // CARTAZINHA DA FRENTE
                // Desenhar moldura da carteirinha (frente) - Azul mais vibrante
                doc.setDrawColor(0);
                doc.setFillColor(25, 55, 109);
                doc.roundedRect(x, y, cardWidth, cardHeight, 2, 2, 'F');
                
                // Borda dourada
                doc.setDrawColor(212, 175, 55);
                doc.setLineWidth(0.5);
                doc.roundedRect(x, y, cardWidth, cardHeight, 2, 2);
                
                try {
                    // Adicionar logo da igreja (tamanho reduzido)
                    doc.addImage({
                        imageData: logoUrl,
                        x: x + 3,
                        y: y + 3,
                        width: 10,
                        height: 10
                    });
                } catch (error) {
                    console.error('Erro ao carregar logo:', error);
                    // Placeholder se a logo não carregar
                    doc.setFillColor(255, 255, 255);
                    doc.roundedRect(x + 3, y + 3, 10, 10, 1, 1, 'F');
                    doc.setTextColor(25, 55, 109);
                    doc.setFontSize(5);
                    doc.text('IEAD', x + 8, y + 8, { align: 'center' });
                }
                
                // Adicionar conteúdo da frente
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(6);
                doc.setFont(undefined, 'bold'); // Texto em negrito
                doc.text('MINISTÉRIO RESGATANDO VIDAS', x + cardWidth/2, y + 7, { align: 'center' });
                
                doc.setFontSize(4);
                doc.setFont(undefined, 'normal'); // Voltar ao normal
                doc.text('Rua Narcisa Amália, nº50 - Imbariê, Duque de Caxias', x + cardWidth/2, y + 10, { align: 'center' });
                
                // LINHA DIVISÓRIA DOURADA MAIS BAIXA (ajustada para y + 16)
                doc.setDrawColor(212, 175, 55);
                doc.setLineWidth(0.3);
                doc.line(x + 5, y + 16, x + cardWidth - 5, y + 16);
                
                // Adicionar foto 3x4 reduzida (15x20mm) - COM BORDA FINA PRETA
                if (member.foto) {
                    try {
                        // Moldura interna para a foto com borda fina preta
                        doc.setDrawColor(0, 0, 0); // Cor preta
                        doc.setLineWidth(0.3); // Borda mais fina
                        doc.setFillColor(255, 255, 255);
                        doc.roundedRect(x + cardWidth - 21, y + 20, 15, 20, 1, 1, 'F');
                        doc.roundedRect(x + cardWidth - 21, y + 20, 15, 20, 1, 1); // Desenhar borda
                        
                        // Adicionar a imagem
                        const img = new Image();
                        img.src = member.foto;
                        
                        await new Promise((resolve) => {
                            img.onload = resolve;
                        });
                        
                        doc.addImage({
                            imageData: member.foto,
                            x: x + cardWidth - 21,
                            y: y + 20,
                            width: 15,
                            height: 20
                        });
                    } catch (error) {
                        console.error('Erro ao adicionar foto:', error);
                        // Se houver erro, adicionar placeholder com borda fina preta
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.3);
                        doc.setFillColor(240, 240, 240);
                        doc.roundedRect(x + cardWidth - 21, y + 20, 15, 20, 1, 1, 'F');
                        doc.roundedRect(x + cardWidth - 21, y + 20, 15, 20, 1, 1);
                        doc.setTextColor(150, 150, 150);
                        doc.setFontSize(4);
                        doc.text('FOTO', x + cardWidth - 13.5, y + 30, { align: 'center' });
                    }
                } else {
                    // Placeholder se não houver foto com borda fina preta
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.3);
                    doc.setFillColor(240, 240, 240);
                    doc.roundedRect(x + cardWidth - 21, y + 20, 15, 20, 1, 1, 'F');
                    doc.roundedRect(x + cardWidth - 21, y + 20, 15, 20, 1, 1);
                    doc.setTextColor(150, 150, 150);
                    doc.setFontSize(4);
                    doc.text('FOTO', x + cardWidth - 13.5, y + 30, { align: 'center' });
                }
                
                // Adicionar detalhes do membro (frente) - TEXTO EM NEGRITO
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(5);
                doc.setFont(undefined, 'bold'); // Texto em negrito
                
                // Textos completos restaurados - POSIÇÕES MAIS BAIXAS
                doc.text(`ID: ${member.id || 'N/A'}`, x + 5, y + 20);
                doc.text(`Nome: ${member.nome || 'N/A'}`, x + 5, y + 24);
                
                doc.setFontSize(4);
                doc.text(`Nasc: ${member.dataNascimento ? new Date(member.dataNascimento).toLocaleDateString('pt-BR') : 'N/A'}`, x + 5, y + 28);
                doc.text(`Batismo: ${member.dataBatismo ? new Date(member.dataBatismo).toLocaleDateString('pt-BR') : 'N/A'}`, x + 5, y + 31);
                
                // Status com cor diferenciada
                doc.setFontSize(4.5);
                if (member.status === 'ativo') {
                    doc.setTextColor(144, 238, 144); // Verde claro para ativo
                } else {
                    doc.setTextColor(255, 165, 165); // Vermelho claro para inativo
                }
                doc.text(`Situação: ${member.status === 'ativo' ? 'ATIVO' : 'INATIVO'}`, x + 5, y + 35);
                
                // Data de validade (adicionada na parte inferior)
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(4);
                doc.setFont(undefined, 'normal'); // Voltar ao normal
                doc.text(`Validade: ${dataValidadeFormatada}`, x + cardWidth/2, y + cardHeight - 3, { align: 'center' });
                
                // CARTAZINHA DO VERSO (lado direito da página)
                const versoX = x + cardWidth + spacing;
                const versoY = y;
                
                // Desenhar moldura da carteirinha (verso) - Fundo branco com borda azul
                doc.setDrawColor(25, 55, 109);
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(versoX, versoY, cardWidth, cardHeight, 2, 2, 'F');
                doc.setLineWidth(0.5);
                doc.roundedRect(versoX, versoY, cardWidth, cardHeight, 2, 2);
                
                // Adicionar logo com opacidade baixa no fundo do verso
                try {
                    // Salvar o estado atual do contexto gráfico
                    doc.saveGraphicsState();
                    
                    // Configurar transparência (opacidade baixa)
                    doc.setGlobalAlpha(0.15);
                    
                    // Adicionar logo no fundo com opacidade baixa
                    doc.addImage({
                        imageData: logoUrl,
                        x: versoX + cardWidth/2 - 15,
                        y: versoY + cardHeight/2 - 15,
                        width: 30,
                        height: 30
                    });
                    
                    // Restaurar o estado do contexto gráfico
                    doc.restoreGraphicsState();
                } catch (error) {
                    console.error('Erro ao adicionar logo de fundo:', error);
                }
                
                // Adicionar conteúdo do verso
                doc.setTextColor(25, 55, 109);
                doc.setFontSize(6);
                doc.setFont(undefined, 'bold'); // Texto em negrito
                doc.text('IEAD - RESGATANDO VIDAS', versoX + cardWidth/2, versoY + 7, { align: 'center' });
                
                doc.setFontSize(4.5);
                doc.text('DOCUMENTO DE IDENTIFICAÇÃO', versoX + cardWidth/2, versoY + 10, { align: 'center' });
                
                // Linha divisória azul
                doc.setDrawColor(25, 55, 109);
                doc.setLineWidth(0.3);
                doc.line(versoX + 5, versoY + 12, versoX + cardWidth - 5, versoY + 12);
                
                // Adicionar detalhes do membro (verso) - TEXTO EM NEGRITO
                doc.setFontSize(4);
                doc.setTextColor(0, 0, 0);
                doc.text(`Pai: ${member.pai || 'N/A'}`, versoX + 5, versoY + 15);
                doc.text(`Mãe: ${member.mae || 'N/A'}`, versoX + 5, versoY + 18);
                doc.text(`Estado Civil: ${member.conjuge ? 'Casado(a)' : 'Solteiro(a)'}`, versoX + 5, versoY + 21);
                doc.text(`Cônjuge: ${member.conjuge || 'N/A'}`, versoX + 5, versoY + 24);
                doc.text(`CPF: ${member.cpf || 'N/A'}`, versoX + 5, versoY + 27);
                doc.text(`Entrada: ${member.dataEntrada ? new Date(member.dataEntrada).toLocaleDateString('pt-BR') : 'N/A'}`, versoX + 5, versoY + 30);
                
                // Data de emissão
                doc.text(`Emissão: ${dataEmissaoFormatada}`, versoX + 5, versoY + 33);
                
                // Linha de assinatura
                doc.setDrawColor(0);
                doc.setLineWidth(0.3);
                doc.line(versoX + 10, versoY + 37, versoX + cardWidth - 10, versoY + 37);
                doc.setFontSize(3.5);
                doc.setFont(undefined, 'normal'); // Voltar ao normal
                doc.text('Pastor Presidente: Cláudio Silva', versoX + cardWidth/2, versoY + 40, { align: 'center' });
                doc.text('Assinatura', versoX + cardWidth/2, versoY + 42, { align: 'center' });
            }
            
            // Gerar URL do PDF e abrir em nova aba
            const pdfBlob = doc.output('blob');
            const pdfUrl = URL.createObjectURL(pdfBlob);
            window.open(pdfUrl, '_blank');
            
            successMessage.textContent = 'Carteirinhas geradas com sucesso! Abrindo em nova aba...';
            successAlert.style.display = 'block';
            
        } catch (error) {
            console.error('Erro ao gerar carteirinhas:', error);
            showError('Erro ao gerar carteirinhas: ' + error.message);
        }
    }
        
        // Função para exibir mensagem de erro
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            
            // Esconder após 5 segundos
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }

        // Ver detalhes do membro
function viewMemberDetails(id, membro) {
    // Formatar datas
    const dataNascimento = membro.dataNascimento ? 
        new Date(membro.dataNascimento).toLocaleDateString('pt-BR') : 'Não informada';
    
    const dataBatismo = membro.dataBatismo ? 
        new Date(membro.dataBatismo).toLocaleDateString('pt-BR') : 'Não informada';
    
    const dataEntrada = membro.dataEntrada ? 
        new Date(membro.dataEntrada).toLocaleDateString('pt-BR') : 'Não informada';
    
    // Criar modal de detalhes
    const modalHTML = `
        <div class="modal active" id="details-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Detalhes do Membro</h2>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 0 0 150px;">
                            <img src="${membro.foto || 'https://via.placeholder.com/150x200?text=Sem+Foto'}" 
                                 alt="${membro.nome}" 
                                 style="width: 150px; height: 200px; object-fit: cover; border-radius: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <h3 style="color: #1a2a6c; margin-bottom: 15px;">${membro.nome}</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div><strong>ID:</strong> ${membro.id || 'N/A'}</div>
                                <div><strong>CPF:</strong> ${membro.cpf || 'Não informado'}</div>
                                <div><strong>Data Nasc.:</strong> ${dataNascimento}</div>
                                <div><strong>Data Batismo:</strong> ${dataBatismo}</div>
                                <div><strong>Data Entrada:</strong> ${dataEntrada}</div>
                                <div><strong>Status:</strong> ${membro.status === 'ativo' ? 'Ativo' : 'Desligado'}</div>
                                <div><strong>Telefone:</strong> ${membro.telefone || 'Não informado'}</div>
                                <div><strong>E-mail:</strong> ${membro.email || 'Não informado'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>Endereço:</strong> ${membro.endereco || 'Não informado'}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div><strong>Pai:</strong> ${membro.pai || 'Não informado'}</div>
                        <div><strong>Mãe:</strong> ${membro.mae || 'Não informado'}</div>
                        <div><strong>Cônjuge:</strong> ${membro.conjuge || 'Não informado'}</div>
                    </div>
                    
                    <div>
                        <strong>Observações:</strong>
                        <p style="margin-top: 5px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            ${membro.observacao || 'Nenhuma observação registrada.'}
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-cancel close-details">Fechar</button>
                </div>
            </div>
        </div>
    `;
    
    // Adicionar modal ao body
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Configurar eventos do modal
    const modal = document.getElementById('details-modal');
    const closeBtn = modal.querySelector('.close-modal');
    const closeDetailsBtn = modal.querySelector('.close-details');
    
    function closeModal() {
        modal.remove();
    }
    
    closeBtn.addEventListener('click', closeModal);
    closeDetailsBtn.addEventListener('click', closeModal);
}

// Editar membro
// Editar membro - VERSÃO CORRIGIDA
function editMember(id, membro) {
    // Preencher o modal de cadastro com os dados do membro
    document.getElementById('nome').value = membro.nome || '';
    document.getElementById('cpf').value = membro.cpf || '';
    document.getElementById('data-nascimento').value = membro.dataNascimento || '';
    document.getElementById('data-entrada').value = membro.dataEntrada || '';
    document.getElementById('data-batismo').value = membro.dataBatismo || '';
    document.getElementById('conjuge').value = membro.conjuge || '';
    document.getElementById('mae').value = membro.mae || '';
    document.getElementById('pai').value = membro.pai || '';
    document.getElementById('email').value = membro.email || '';
    document.getElementById('telefone').value = membro.telefone || '';
    document.getElementById('endereco').value = membro.endereco || '';
    document.getElementById('observacao').value = membro.observacao || '';
    
    if (membro.foto) {
        photoBase64 = membro.foto;
        photoPreview.innerHTML = `<img src="${membro.foto}" alt="Preview">`;
    } else {
        photoBase64 = null;
        photoPreview.innerHTML = '<i class="fas fa-user fa-3x" style="color: #ddd;"></i>';
    }
    
    // Alterar o título do modal
    document.querySelector('.modal-title').textContent = 'Editar Membro';
    
    // Alterar comportamento do botão salvar para edição
    const saveBtn = document.getElementById('save-member-btn');
    saveBtn.textContent = 'Atualizar';
    saveBtn.onclick = function() {
        updateMember(id);
    };
    
    // Abrir modal
    memberModal.classList.add('active');
}

// Excluir membro
async function deleteMember(id) {
    if (!confirm('Tem certeza que deseja excluir este membro permanentemente? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    try {
        await db.collection('membros').doc(id).delete();
        
        successMessage.textContent = 'Membro excluído com sucesso!';
        successAlert.style.display = 'block';
        
        loadMembers();
        
    } catch (error) {
        showError('Erro ao excluir membro: ' + error.message);
    }
}

// Variável global para armazenar todos os membros filtrados
let currentFilteredMembers = [];

// Inicializar funcionalidade de busca
function initSearch() {
    const searchContainer = document.getElementById('search-container');
    const searchInput = document.getElementById('member-search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    
    // Mostrar campo de busca apenas nas abas de ativos e desligados
    updateSearchVisibility();
    
    // Evento de input para busca em tempo real
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (searchTerm.length > 0) {
            clearSearchBtn.style.display = 'block';
            filterMembers(searchTerm);
        } else {
            clearSearchBtn.style.display = 'none';
            clearSearch();
        }
    });
    
    // Evento para limpar busca
    clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        clearSearchBtn.style.display = 'none';
        clearSearch();
    });
    
    // Evento para tecla Escape
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            searchInput.value = '';
            clearSearchBtn.style.display = 'none';
            clearSearch();
        }
    });
}

// Atualizar visibilidade do campo de busca baseado na aba atual
function updateSearchVisibility() {
    const searchContainer = document.getElementById('search-container');
    
    if (selectedTab === 'ativos' || selectedTab === 'desligados') {
        searchContainer.style.display = 'block';
    } else {
        searchContainer.style.display = 'none';
    }
}

// Filtrar membros
function filterMembers(searchTerm) {
    const currentTab = selectedTab;
    const tbodyId = `${currentTab}-list`;
    const tbody = document.getElementById(tbodyId);
    
    if (!tbody) return;
    
    // Obter todos os membros da aba atual
    const allMembers = currentFilteredMembers.filter(member => 
        member.status === (currentTab === 'ativos' ? 'ativo' : 'desligado')
    );
    
    // Filtrar membros baseado no termo de busca
    const filteredMembers = allMembers.filter(member => {
        return (
            (member.id && member.id.toLowerCase().includes(searchTerm)) ||
            (member.nome && member.nome.toLowerCase().includes(searchTerm)) ||
            (member.funcao && member.funcao.toLowerCase().includes(searchTerm)) ||
            (currentFilial && currentFilial.congregacao && currentFilial.congregacao.toLowerCase().includes(searchTerm))
        );
    });
    
    // Atualizar a tabela com os resultados filtrados
    renderFilteredMembers(tbody, filteredMembers, searchTerm);
}

// Renderizar membros filtrados
function renderFilteredMembers(tbody, filteredMembers, searchTerm) {
    tbody.innerHTML = '';
    
    if (filteredMembers.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="no-members">
                    <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                    Nenhum membro encontrado para "<strong>${searchTerm}</strong>"
                </td>
            </tr>
        `;
        return;
    }
    
    filteredMembers.forEach(memberData => {
        const row = createMemberTableRow(memberData.id, memberData);
        tbody.appendChild(row);
    });
    
    // Adicionar informação de resultados
    const resultsInfo = document.createElement('div');
   
    
    // Remover info anterior se existir
    const existingInfo = tbody.parentNode.querySelector('.search-results-info');
    if (existingInfo) {
        existingInfo.remove();
    }
    
    tbody.parentNode.appendChild(resultsInfo);
}

// Limpar busca
function clearSearch() {
    const currentTab = selectedTab;
    const tbodyId = `${currentTab}-list`;
    const tbody = document.getElementById(tbodyId);
    
    if (!tbody) return;
    
    // Recarregar membros normais
    const allMembers = currentFilteredMembers.filter(member => 
        member.status === (currentTab === 'ativos' ? 'ativo' : 'desligado')
    );
    
    tbody.innerHTML = '';
    
    if (allMembers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-members">Nenhum membro encontrado</td></tr>';
    } else {
        allMembers.forEach(memberData => {
            const row = createMemberTableRow(memberData.id, memberData);
            tbody.appendChild(row);
        });
    }
    
    // Remover info de resultados
    const existingInfo = tbody.parentNode.querySelector('.search-results-info');
    if (existingInfo) {
        existingInfo.remove();
    }
}


        
    </script>
</body>
</html>